[{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\index.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":27,"column":58,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":27,"endColumn":59,"suggestions":[{"messageId":"removeEscape","fix":{"range":[972,973],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[972,972],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":28,"column":48,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":28,"endColumn":49,"suggestions":[{"messageId":"removeEscape","fix":{"range":[1039,1040],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[1039,1039],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":139,"column":64,"nodeType":"BlockStatement","messageId":"unexpected","endLine":139,"endColumn":66,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[4583,4583],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":238,"column":17,"nodeType":"BlockStatement","messageId":"unexpected","endLine":238,"endColumn":19,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[7838,7838],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'dotenv/config';\r\nimport express from 'express';\r\nimport multer from 'multer';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport { processFile } from './lib/processor';\r\nimport crypto from 'crypto';\r\nimport { exec, execFile } from 'child_process';\r\nimport helmet from 'helmet';\r\n\r\nconst logger = {\r\n  info: (msg: string) => console.log(`[INFO] ${new Date().toISOString()} ${msg}`),\r\n  error: (msg: string, err?: unknown) => console.error(`[ERROR] ${new Date().toISOString()} ${msg}`, err),\r\n};\r\n\r\nasync function saveImageSlice(buffer: Buffer, uploadDir: string): Promise<string> {\r\n  const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.png`;\r\n  const filePath = path.join(uploadDir, fileName);\r\n  await fs.promises.writeFile(filePath, buffer);\r\n  return `/uploads/${fileName}`;\r\n}\r\n\r\nconst app = express();\r\nconst port = process.env.PORT || 3000;\r\n\r\n// Input Validation Helpers\r\nconst isValidFilename = (name: string) => /^[a-zA-Z0-9_\\-\\.]+$/.test(name);\r\nconst isValidId = (id: string) => /^[a-zA-Z0-9_\\-]+$/.test(id);\r\nconst isSafePath = (p: string) => !path.normalize(p).includes('..');\r\n\r\n// Configure Multer with limit from env\r\nconst upload = multer({ \r\n  dest: 'uploads/',\r\n  limits: { fileSize: parseInt(process.env.MAX_FILE_SIZE || '52428800') }\r\n});\r\n\r\n// Create uploads directory if it doesn't exist\r\nif (!fs.existsSync('uploads')) {\r\n  fs.mkdirSync('uploads');\r\n}\r\n\r\napp.use(helmet({\r\n  contentSecurityPolicy: false,\r\n}));\r\napp.use(express.json({ limit: '50mb' }));\r\n\r\n// Server-side Folder Picker (Windows only)\r\napp.get('/api/pick-folder', (_req, res) => {\r\n  if (process.platform !== 'win32') {\r\n    return res.status(400).json({ error: 'Folder picker is only supported on Windows server hosting.' });\r\n  }\r\n\r\n  const psCommand = `\r\n    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8;\r\n    Add-Type -AssemblyName System.Windows.Forms;\r\n    $f = New-Object System.Windows.Forms.FolderBrowserDialog;\r\n    $f.ShowNewFolderButton = $true;\r\n    if ($f.ShowDialog() -eq 'OK') { Write-Host $f.SelectedPath }\r\n  `;\r\n\r\n  exec(`powershell -nop -c \"${psCommand.replace(/\\n/g, ' ')}\"`, (error, stdout, stderr) => {\r\n    if (error) {\r\n      console.error('[API] Folder picker error:', stderr || error.message);\r\n      return res.status(500).json({ error: 'Failed to open folder picker' });\r\n    }\r\n    const selectedPath = stdout.trim();\r\n    if (selectedPath) {\r\n      res.json({ path: selectedPath });\r\n    } else {\r\n      res.json({ canceled: true });\r\n    }\r\n  });\r\n});\r\n\r\n// Open Folder in Explorer\r\napp.post('/api/open-folder', (req, res) => {\r\n  const { path: folderPath } = req.body;\r\n  if (!folderPath) return res.status(400).json({ error: 'Path is required' });\r\n\r\n  // Windows specific - Safe execution\r\n  execFile('explorer.exe', [folderPath], (error) => {\r\n    if (error) {\r\n      logger.error('Failed to open folder:', error);\r\n      return res.status(500).json({ error: 'Failed to open folder' });\r\n    }\r\n    res.json({ success: true });\r\n  });\r\n});\r\n\r\n// API Endpoints\r\napp.post('/api/upload', upload.single('file'), async (req, res) => {\r\n\r\n  try {\r\n    if (!req.file) {\r\n\r\n      return res.status(400).json({ error: 'No file uploaded' });\r\n    }\r\n    \r\n\r\n    const { sliceHeight } = req.body;\r\n    const height = sliceHeight ? parseInt(sliceHeight) : 0; // Default to 0 (no slice)\r\n\r\n    const { slices } = await processFile(req.file.path, req.file.mimetype, height);\r\n    \r\n    // Cleanup uploaded temp file\r\n    try {\r\n        if (fs.existsSync(req.file.path)) {\r\n            fs.unlinkSync(req.file.path);\r\n        }\r\n    } catch (cleanupError) {\r\n        console.error('[API] Warning: Failed to delete temp file:', cleanupError);\r\n    }\r\n\r\n    // Save slices to public/uploads\r\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads');\r\n    if (!fs.existsSync(uploadDir)) {\r\n      await fs.promises.mkdir(uploadDir, { recursive: true });\r\n    }\r\n\r\n    const processedSlices = await Promise.all(slices.map(async (slice) => {\r\n       const imageUrl = await saveImageSlice(slice.buffer, uploadDir);\r\n       return {\r\n           imageUrl,\r\n           links: slice.links\r\n       };\r\n    }));\r\n\r\n    const imagesList = processedSlices.map(s => s.imageUrl);\r\n\r\n    res.json({ \r\n        images: imagesList,\r\n        slices: processedSlices // New field with metadata\r\n    });\r\n  } catch (error) {\r\n    logger.error('Error processing file:', error);\r\n    \r\n    // Attempt cleanup on error too\r\n    if (req.file && fs.existsSync(req.file.path)) {\r\n        try { await fs.promises.unlink(req.file.path); } catch {}\r\n    }\r\n\r\n    res.status(500).json({ error: 'Failed to process file', details: error instanceof Error ? error.message : String(error) });\r\n  }\r\n});\r\n\r\n// Newsletter Storage Endpoints\r\nconst DATA_DIR = path.join(process.cwd(), 'server', 'data', 'newsletters');\r\nif (!fs.existsSync(DATA_DIR)) {\r\n  fs.mkdirSync(DATA_DIR, { recursive: true });\r\n}\r\n\r\n// List all newsletters\r\napp.get('/api/newsletters', async (_req, res) => {\r\n  try {\r\n    const files = (await fs.promises.readdir(DATA_DIR)).filter(f => f.endsWith('.json'));\r\n    const newsletters = await Promise.all(files.map(async (file) => {\r\n      const content = JSON.parse(await fs.promises.readFile(path.join(DATA_DIR, file), 'utf-8'));\r\n      return {\r\n        id: content.id,\r\n        title: content.title,\r\n        createdAt: content.createdAt,\r\n        updatedAt: content.updatedAt\r\n      };\r\n    }));\r\n    newsletters.sort((a, b) => b.updatedAt - a.updatedAt);\r\n    \r\n    res.json(newsletters);\r\n  } catch (error) {\r\n    logger.error('Error listing newsletters:', error);\r\n    res.status(500).json({ error: 'Failed to list newsletters' });\r\n  }\r\n});\r\n\r\n// Get specific newsletter\r\napp.get('/api/newsletters/:id', async (req, res) => {\r\n  if (!isValidId(req.params.id)) {\r\n      return res.status(400).json({ error: 'Invalid ID format' });\r\n  }\r\n  try {\r\n    const filePath = path.join(DATA_DIR, `${req.params.id}.json`);\r\n    try {\r\n        const content = JSON.parse(await fs.promises.readFile(filePath, 'utf-8'));\r\n        res.json(content);\r\n    } catch {\r\n        return res.status(404).json({ error: 'Newsletter not found' });\r\n    }\r\n  } catch (error) {\r\n    logger.error(`Error reading newsletter ${req.params.id}:`, error);\r\n    res.status(500).json({ error: 'Failed to read newsletter' });\r\n  }\r\n});\r\n\r\n// Delete newsletter\r\napp.delete('/api/newsletters/:id', async (req, res) => {\r\n  if (!isValidId(req.params.id)) {\r\n      return res.status(400).json({ error: 'Invalid ID format' });\r\n  }\r\n  try {\r\n    const filePath = path.join(DATA_DIR, `${req.params.id}.json`);\r\n    if (fs.existsSync(filePath)) {\r\n      await fs.promises.unlink(filePath);\r\n      res.json({ success: true });\r\n    } else {\r\n      res.status(404).json({ error: 'Newsletter not found' });\r\n    }\r\n  } catch (error) {\r\n    logger.error(`Error deleting newsletter ${req.params.id}:`, error);\r\n    res.status(500).json({ error: 'Failed to delete newsletter' });\r\n  }\r\n});\r\n\r\n// Save newsletter\r\napp.post('/api/newsletters', async (req, res) => {\r\n  try {\r\n    const { id, title, blocks } = req.body;\r\n    \r\n    if (!blocks) {\r\n        return res.status(400).json({ error: 'Missing blocks data' });\r\n    }\r\n\r\n    const newsletterId = id || crypto.randomUUID();\r\n    const now = Date.now();\r\n    \r\n    const newsletter = {\r\n      id: newsletterId,\r\n      title: title || 'Untitled Newsletter',\r\n      createdAt: id ? undefined : now,\r\n      updatedAt: now,\r\n      blocks\r\n    };\r\n\r\n    // If updating, try to preserve createdAt\r\n    const filePath = path.join(DATA_DIR, `${newsletterId}.json`);\r\n    if (fs.existsSync(filePath)) {\r\n        try {\r\n            const existing = JSON.parse(await fs.promises.readFile(filePath, 'utf-8'));\r\n            newsletter.createdAt = existing.createdAt || now;\r\n        } catch {}\r\n    } else {\r\n        newsletter.createdAt = now;\r\n    }\r\n\r\n    await fs.promises.writeFile(filePath, JSON.stringify(newsletter, null, 2));\r\n    \r\n\r\n    res.json({ success: true, id: newsletterId, newsletter });\r\n  } catch (error) {\r\n    logger.error('Error saving newsletter:', error);\r\n    res.status(500).json({ error: 'Failed to save newsletter' });\r\n  }\r\n});\r\n\r\n// Settings & Export Endpoints (Restoring missing endpoints)\r\nconst DATA_FILE = path.join(process.cwd(), 'server', 'data', 'settings.json');\r\n\r\napp.get('/api/settings', async (_req, res) => {\r\n  try {\r\n    if (fs.existsSync(DATA_FILE)) {\r\n      const settings = JSON.parse(await fs.promises.readFile(DATA_FILE, 'utf-8'));\r\n      res.json(settings);\r\n    } else {\r\n      res.json({ exportPath: '' });\r\n    }\r\n  } catch (error) {\r\n    logger.error('Failed to load settings', error);\r\n    res.json({ exportPath: '' });\r\n  }\r\n});\r\n\r\napp.post('/api/settings', async (req, res) => {\r\n  try {\r\n    const { exportPath } = req.body;\r\n    \r\n    if (exportPath && !isSafePath(exportPath)) {\r\n        return res.status(400).json({ error: 'Invalid export path' });\r\n    }\r\n\r\n    await fs.promises.writeFile(DATA_FILE, JSON.stringify({ exportPath }, null, 2));\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    logger.error('Failed to save settings', error);\r\n    res.status(500).json({ error: 'Failed to save settings' });\r\n  }\r\n});\r\n\r\n// Image to Base64 API for HTML export\r\napp.get('/api/image-base64', async (req, res) => {\r\n  const { path: imagePath } = req.query;\r\n  if (!imagePath || typeof imagePath !== 'string') {\r\n    return res.status(400).json({ error: 'Path required' });\r\n  }\r\n\r\n  // Security: Prevent Path Traversal\r\n  const normalizedPath = path.normalize(imagePath);\r\n  if (normalizedPath.includes('..') || path.isAbsolute(normalizedPath)) {\r\n      logger.error(`Blocked attempted path traversal: ${imagePath}`);\r\n      return res.status(403).json({ error: 'Invalid path' });\r\n  }\r\n\r\n  const fullPath = path.join(process.cwd(), 'public', normalizedPath);\r\n  if (!fs.existsSync(fullPath)) {\r\n    return res.status(404).json({ error: 'Image not found' });\r\n  }\r\n\r\n  try {\r\n    const buffer = await fs.promises.readFile(fullPath);\r\n    const base64 = buffer.toString('base64');\r\n    const ext = path.extname(imagePath).slice(1).toLowerCase() || 'png';\r\n    const mimeType = ext === 'jpg' ? 'jpeg' : ext;\r\n\r\n    res.json({ dataUri: `data:image/${mimeType};base64,${base64}` });\r\n  } catch (e) {\r\n    logger.error('Failed to read image', e);\r\n    res.status(500).json({ error: 'Failed to read image' });\r\n  }\r\n});\r\n\r\napp.post('/api/export', async (req, res) => {\r\n  try {\r\n    const { html, path: exportPath, filename } = req.body;\r\n    if (!html || !exportPath || !filename) {\r\n      return res.status(400).json({ error: 'Missing required fields' });\r\n    }\r\n\r\n    if (!isValidFilename(filename)) {\r\n        return res.status(400).json({ error: 'Invalid filename' });\r\n    }\r\n\r\n    if (!isSafePath(exportPath)) {\r\n        return res.status(400).json({ error: 'Invalid export path' });\r\n    }\r\n\r\n    // Basic validation of export path (simple check)\r\n    // In a real app we might want to strictly allow only certain directories\r\n    \r\n    if (!fs.existsSync(exportPath)) {\r\n      await fs.promises.mkdir(exportPath, { recursive: true });\r\n    }\r\n\r\n    const fullPath = path.join(exportPath, filename);\r\n    await fs.promises.writeFile(fullPath, html, 'utf-8');\r\n    \r\n    res.json({ success: true, path: fullPath });\r\n  } catch (error) {\r\n    logger.error('Export failed:', error);\r\n    res.status(500).json({ error: error instanceof Error ? error.message : 'Failed to export file' });\r\n  }\r\n});\r\n\r\napp.listen(port, '0.0.0.0', () => {\r\n  console.log(`Server running at http://0.0.0.0:${port}`);\r\n  \r\n  // Keep process alive hack (if event loop is draining)\r\n  setInterval(() => {}, 1000 * 60 * 60);\r\n});\r\n\r\n// Log exit reasons\r\nprocess.on('exit', (code) => {\r\n    console.log(`[API] Server process exiting with code: ${code}`);\r\n});\r\n\r\nprocess.on('uncaughtException', (err) => {\r\n    console.error('[API] Uncaught Exception:', err);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\html-generator.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\html-generator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\image-slicer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\pdf-converter.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":24,"column":3,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":24,"endColumn":16,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[890,903],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":28,"column":3,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":28,"endColumn":16,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1054,1067],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1760,1763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1760,1763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2011,2014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2011,2014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2072,2075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2072,2075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'x' is assigned a value but never used.","line":72,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'y' is assigned a value but never used.","line":73,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":16}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Polyfills for PDF.js in Node environment\r\nimport './pdf-polyfills'; // Must be imported before pdfjs-dist\r\nimport { createCanvas } from '@napi-rs/canvas';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\nexport interface LinkInfo {\r\n  url: string;\r\n  x: number;      // Canvas coordinates (Top-Left origin)\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n  pageIndex: number;\r\n}\r\n\r\nexport async function convertPdfToImages(filePath: string): Promise<{ images: Buffer[], links: LinkInfo[][] }> {\r\n  // Dynamically import pdfjs to ensure polyfills are applied first\r\n  const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf.mjs');\r\n\r\n  console.log('[pdf-converter] Using @napi-rs/canvas');\r\n\r\n  // Configure worker for Node.js environment\r\n  const standardFontDataUrl = path.join(process.cwd(), 'node_modules', 'pdfjs-dist', 'standard_fonts').split(path.sep).join('/') + '/';\r\n  // @ts-ignore\r\n  pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs-dist/legacy/build/pdf.worker.mjs';\r\n\r\n  const data = new Uint8Array(fs.readFileSync(filePath));\r\n  // @ts-ignore\r\n  const loadingTask = pdfjsLib.getDocument({\r\n    data: data,\r\n    standardFontDataUrl: standardFontDataUrl,\r\n    // canvasFactory 제거 - pdf.js 내장 NodeCanvasFactory가 @napi-rs/canvas 사용\r\n  });\r\n  const pdfDocument = await loadingTask.promise;\r\n  const numPages = pdfDocument.numPages;\r\n  const images: Buffer[] = [];\r\n  const links: LinkInfo[][] = [];\r\n\r\n  for (let i = 1; i <= numPages; i++) {\r\n    const page = await pdfDocument.getPage(i);\r\n    const viewport = page.getViewport({ scale: 2.0 }); // High quality 2x\r\n\r\n    const canvas = createCanvas(viewport.width, viewport.height);\r\n    const context = canvas.getContext('2d');\r\n\r\n    await page.render({\r\n      canvasContext: context as any,\r\n      viewport: viewport,\r\n    }).promise;\r\n\r\n    images.push(canvas.toBuffer('image/png'));\r\n\r\n    // Extract annotations\r\n    const annotations = await page.getAnnotations();\r\n    const pageLinks: LinkInfo[] = annotations\r\n      .filter((ann: any) => ann.subtype === 'Link' && ann.url)\r\n      .map((ann: any) => {\r\n        // PDF rect is [x1, y1, x2, y2] where (0,0) is bottom-left\r\n        // Viewport conversion handles the coordinate transform\r\n        const rect = viewport.convertToViewportRectangle(ann.rect);\r\n        // rect is now [x1, y1, x2, y2] in top-left coordinates BUT:\r\n        // convertToViewportRectangle returns [xMin, yMin, xMax, yMax] ? \r\n        // Let's verify standard behavior: usually it transforms the rect.\r\n        // If scale is 2.0, coordinates are scaled.\r\n        // PDF JS convertToViewportRectangle returns [x1, y1, x2, y2] normalized to the viewport.\r\n        \r\n        // Let's manually calculate width/height from the transformed rect\r\n        // The rect output from convertToViewportRectangle is [xMin, yMin, xMax, yMax]\r\n        // Note: PDF coordinates y increases UPWARDS. Canvas y increases DOWNWARDS.\r\n        // convertToViewportRectangle handles the flipping.\r\n        \r\n        const x = rect[0];\r\n        const y = rect[1]; // Top-left y?\r\n        // Actually, let's normalize. \r\n        // rect usually comes out as [x_min, y_min, x_max, y_max] relative to the canvas.\r\n        // But let's be safe and check min/max.\r\n        \r\n        const xMin = Math.min(rect[0], rect[2]);\r\n        const xMax = Math.max(rect[0], rect[2]);\r\n        const yMin = Math.min(rect[1], rect[3]); // Top-most y in canvas coords\r\n        const yMax = Math.max(rect[1], rect[3]); // Bottom-most y in canvas coords\r\n\r\n        return {\r\n          url: ann.url,\r\n          x: xMin,\r\n          y: yMin,\r\n          width: xMax - xMin,\r\n          height: yMax - yMin,\r\n          pageIndex: i - 1\r\n        };\r\n      });\r\n      \r\n    links.push(pageLinks);\r\n  }\r\n\r\n  return { images, links };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\pdf-polyfills.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":5,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[131,134],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[131,134],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[236,239],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[236,239],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[663,666],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[663,666],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[702,705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[702,705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[729,732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[729,732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[766,769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[766,769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[887,890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[887,890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[927,930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[927,930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1016,1019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1016,1019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1049,1052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1049,1052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1094,1097],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1094,1097],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1121,1124],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1121,1124],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1174,1177],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1174,1177],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1221,1224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1221,1224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1265,1268],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1265,1268],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1311,1314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1311,1314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":47,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":47,"endColumn":18,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1436,1449],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1752,1755],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1752,1755],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1797,1800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1797,1800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1824,1827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1824,1827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":20,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Image, createCanvas } from '@napi-rs/canvas';\r\n\r\n// window polyfill\r\nif (typeof window === 'undefined') {\r\n    (global as any).window = global;\r\n}\r\n\r\n// document polyfill\r\nif (typeof document === 'undefined') {\r\n    (global as any).document = {\r\n        createElement: (tagName: string) => {\r\n            if (tagName.toLowerCase() === 'img') {\r\n                return new Image();\r\n            }\r\n            if (tagName.toLowerCase() === 'canvas') {\r\n                return createCanvas(1, 1);\r\n            }\r\n            return {};\r\n        },\r\n        head: {},\r\n        body: {},\r\n    };\r\n}\r\n\r\n// Image polyfill\r\nif (!global.Image) {\r\n    (global as any).Image = Image;\r\n}\r\nif ((global as any).window && !(global as any).window.Image) {\r\n    (global as any).window.Image = Image;\r\n}\r\n\r\n// requestAnimationFrame polyfill\r\nif (!global.requestAnimationFrame) {\r\n    (global as any).requestAnimationFrame = (callback: any) => setTimeout(callback, 0);\r\n}\r\nif (!global.cancelAnimationFrame) {\r\n    (global as any).cancelAnimationFrame = (id: any) => clearTimeout(id);\r\n}\r\nif ((global as any).window && !(global as any).window.requestAnimationFrame) {\r\n    (global as any).window.requestAnimationFrame = (global as any).requestAnimationFrame;\r\n    (global as any).window.cancelAnimationFrame = (global as any).cancelAnimationFrame;\r\n}\r\n\r\n// Promise.withResolvers polyfill\r\nif (typeof Promise.withResolvers === 'undefined') {\r\n    // @ts-ignore\r\n    Promise.withResolvers = function () {\r\n        let resolve, reject;\r\n        const promise = new Promise((res, rej) => {\r\n            resolve = res;\r\n            reject = rej;\r\n        });\r\n        return { promise, resolve, reject };\r\n    };\r\n}\r\n\r\n// Promise.try polyfill\r\nif (typeof (Promise as any).try === 'undefined') {\r\n    (Promise as any).try = function (func: any) {\r\n        return new Promise((resolve, reject) => {\r\n            try {\r\n                resolve(func());\r\n            } catch (e) {\r\n                reject(e);\r\n            }\r\n        });\r\n    };\r\n}\r\n\r\nconsole.log('[PDF Polyfills] Applied @napi-rs/canvas polyfills');\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\processor.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'path' is defined but never used.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"path"},"fix":{"range":[124,150],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'sliceBuffer' is assigned a value but never used.","line":55,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":22}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi } from 'vitest';\r\nimport { processFile } from './processor';\r\nimport sharp from 'sharp';\r\nimport path from 'path';\r\n\r\n// Mock pdf-converter\r\nvi.mock('./pdf-converter', () => ({\r\n  convertPdfToImages: vi.fn().mockImplementation(async () => {\r\n    // Create two dummy images (100x100 white squares)\r\n    const img1 = await sharp({\r\n      create: { width: 100, height: 100, channels: 4, background: { r: 255, g: 0, b: 0, alpha: 1 } }\r\n    }).png().toBuffer();\r\n\r\n    const img2 = await sharp({\r\n      create: { width: 100, height: 100, channels: 4, background: { r: 0, g: 255, b: 0, alpha: 1 } }\r\n    }).png().toBuffer();\r\n\r\n    return {\r\n      images: [img1, img2],\r\n      links: [\r\n        [{ url: 'http://p1.com', x: 10, y: 10, width: 20, height: 20, pageIndex: 0 }],\r\n        [{ url: 'http://p2.com', x: 20, y: 20, width: 30, height: 30, pageIndex: 1 }]\r\n      ]\r\n    };\r\n  }),\r\n  LinkInfo: {}\r\n}));\r\n\r\n// Mock html-generator (not used in logic test but imported)\r\nvi.mock('./html-generator', () => ({\r\n  generateHtml: vi.fn()\r\n}));\r\n\r\n// Mock image-slicer to behave predictably\r\n// But processor uses real image-slicer. Let's not mock it if possible, \r\n// or verify behavior with real one. \r\n// image-slicer resizes to 800px width.\r\n// Original images are 100px width. \r\n// scale = 800 / 100 = 8.\r\n// Page 1 height (100) -> resized height 800.\r\n// Page 2 height (100) -> resized height 800.\r\n// Total merged height = 200 (original) -> 1600 (resized).\r\n\r\n// Links:\r\n// P1 link: x=10, y=10. Scaled: x=80, y=80.\r\n// P2 link: x=20, y=20.\r\n// Merged P2 link Y (original) = 100 + 20 = 120.\r\n// Scaled P2 link Y = 120 * 8 = 960.\r\n\r\ndescribe('Processor', () => {\r\n  it('should merge multiple pages and adjust link coordinates', async () => {\r\n    const result = await processFile('dummy.pdf', 'application/pdf', 0);\r\n    \r\n    expect(result.slices).toHaveLength(1); // Should be 1 slice because height is 0 (infinite)\r\n    const sliceBuffer = result.slices[0].buffer;\r\n    const links = result.slices[0].links;\r\n\r\n    // Verify links\r\n    expect(links).toHaveLength(2);\r\n    \r\n    // Validating Link 1\r\n    const l1 = links.find(l => l.url === 'http://p1.com');\r\n    expect(l1).toBeDefined();\r\n    // x: 10 * 8 = 80\r\n    // y: 10 * 8 = 80\r\n    expect(Math.round(l1!.x)).toBe(80);\r\n    expect(Math.round(l1!.y)).toBe(80);\r\n\r\n    // Validating Link 2\r\n    const l2 = links.find(l => l.url === 'http://p2.com');\r\n    expect(l2).toBeDefined();\r\n    // x: 20 * 8 = 160\r\n    // y: (100 + 20) * 8 = 960\r\n    expect(Math.round(l2!.x)).toBe(160);\r\n    expect(Math.round(l2!.y)).toBe(960);\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\lib\\processor.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SliceInfo' is defined but never used.","line":2,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SliceInfo"},"fix":{"range":[84,95],"text":""},"desc":"Remove unused variable \"SliceInfo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'generateHtml' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":22,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"generateHtml"},"fix":{"range":[122,172],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"prefer-const","severity":2,"message":"'finalSlices' is never reassigned. Use 'const' instead.","line":87,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":87,"endColumn":38,"fix":{"range":[2699,2738],"text":"const finalSlices: ProcessedSlice[] = [];"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { convertPdfToImages, LinkInfo } from './pdf-converter';\r\nimport { sliceImage, SliceInfo } from './image-slicer';\r\nimport { generateHtml } from './html-generator';\r\nimport fs from 'fs';\r\nimport sharp from 'sharp';\r\n\r\nexport interface ProcessedSlice {\r\n  buffer: Buffer;\r\n  links: LinkInfo[];\r\n}\r\n\r\nexport async function processFile(filePath: string, mimeType: string, sliceHeight: number) {\r\n\r\n  let images: Buffer[] = [];\r\n  let links: LinkInfo[][] = [];\r\n\r\n  try {\r\n    if (mimeType === 'application/pdf') {\r\n\r\n        const result = await convertPdfToImages(filePath);\r\n        images = result.images;\r\n        links = result.links;\r\n\r\n\r\n        // Merge pages if there are multiple\r\n        if (images.length > 1) {\r\n\r\n            \r\n            // 1. Get metadata for all pages to calculate dimensions\r\n            const pageMetas = await Promise.all(images.map(img => sharp(img).metadata()));\r\n            const totalHeight = pageMetas.reduce((sum, meta) => sum + (meta.height || 0), 0);\r\n            const maxWidth = Math.max(...pageMetas.map(meta => meta.width || 0));\r\n\r\n            // 2. Composite images\r\n            const compositeOperations = [];\r\n            let currentY = 0;\r\n            let mergedLinks: LinkInfo[] = [];\r\n\r\n            for (let i = 0; i < images.length; i++) {\r\n                const meta = pageMetas[i];\r\n                compositeOperations.push({\r\n                    input: images[i],\r\n                    top: currentY,\r\n                    left: 0\r\n                });\r\n\r\n                // Adjust link coordinates\r\n                if (links[i]) {\r\n                    const pageLinks = links[i].map(link => ({\r\n                        ...link,\r\n                        y: link.y + currentY // Offset by previous pages' height\r\n                    }));\r\n                    mergedLinks = mergedLinks.concat(pageLinks);\r\n                }\r\n\r\n                currentY += (meta.height || 0);\r\n            }\r\n\r\n            // Create blank canvas and composite\r\n            const mergedImage = await sharp({\r\n                create: {\r\n                    width: maxWidth,\r\n                    height: totalHeight,\r\n                    channels: 4,\r\n                    background: { r: 255, g: 255, b: 255, alpha: 1 }\r\n                }\r\n            })\r\n            .composite(compositeOperations)\r\n            .png() // Ensure output is PNG\r\n            .toBuffer();\r\n\r\n            // Replace images and links with the single merged result\r\n            images = [mergedImage];\r\n            links = [mergedLinks];\r\n\r\n        }\r\n\r\n    } else {\r\n\r\n        images = [fs.readFileSync(filePath)];\r\n        links = [[]];\r\n\r\n    }\r\n\r\n    // Slice each image\r\n\r\n    let finalSlices: ProcessedSlice[] = [];\r\n    \r\n    // If sliceHeight is 0, we still need to process it through our pipeline (resize + link scaling)\r\n    // But sliceImage handles resizing to 800px.\r\n    // If sliceHeight <= 0, we pass a very large number effectively implementation \"no slice\" but still verify logic.\r\n    // Actually sliceImage function handles logic. But let's check the param.\r\n    const effectiveSliceHeight = sliceHeight <= 0 ? 100000 : sliceHeight;\r\n\r\n    for (let i = 0; i < images.length; i++) {\r\n        const imgBuf = images[i];\r\n        const pageLinks = links[i] || [];\r\n\r\n        // Get original width to calculate scale\r\n        const meta = await sharp(imgBuf).metadata();\r\n        const originalWidth = meta.width!;\r\n        // Scale to 1600px (Retina)\r\n        const scale = 1600 / originalWidth;\r\n\r\n        // Slice (this also resizes to 1600px width)\r\n        const slices = await sliceImage(imgBuf, effectiveSliceHeight);\r\n\r\n        for (const slice of slices) {\r\n             // Filter and adjust links\r\n             const sliceLinks = pageLinks.map(link => {\r\n                // Scale link to 1600px width\r\n                const lx = link.x * scale;\r\n                const ly = link.y * scale;\r\n                const lw = link.width * scale;\r\n                const lh = link.height * scale;\r\n\r\n                // Relative Y to the slice\r\n                const relativeY = ly - slice.y;\r\n\r\n                return {\r\n                   ...link,\r\n                   x: lx,\r\n                   y: relativeY,\r\n                   width: lw,\r\n                   height: lh\r\n                };\r\n             }).filter(link => {\r\n                // Keep if it overlaps with the slice\r\n                // Link vertical range: [y, y + height] (relative to slice)\r\n                // Slice vertical range: [0, slice.height]\r\n                return (link.y + link.height > 0) && (link.y < slice.height);\r\n             });\r\n\r\n             finalSlices.push({\r\n                 buffer: slice.buffer,\r\n                 links: sliceLinks\r\n             });\r\n        }\r\n    }\r\n\r\n\r\n    return { slices: finalSlices };\r\n  } catch (err) {\r\n    console.error('[Processor] Error:', err);\r\n    throw err;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\server\\test\\upload.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\App.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_mouseDownEvent' is defined but never used.","line":87,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":41},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'resize'. Either include it or remove the dependency array.","line":115,"column":6,"nodeType":"ArrayExpression","endLine":115,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [isResizing, resize]","fix":{"range":[3908,3920],"text":"[isResizing, resize]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5859,5862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5859,5862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5923,5926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5923,5926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":177,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6049,6052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6049,6052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":260,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":260,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":388,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":388,"endColumn":17},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":448,"column":7,"severity":1,"nodeType":null,"fix":{"range":[15008,15070],"text":" "}}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":451,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15226,15229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15226,15229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":6,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { useState, useEffect, useCallback } from 'react';\nimport './App.css';\nimport { Preview } from './components/Preview';\n\nimport { BlockList } from './components/Editor/BlockList';\nimport type { Block, NewsletterSummary } from './types';\nimport { Mail, Settings, Download, FolderOpen, Trash2 } from 'lucide-react';\nimport { useToast } from './components/Toast';\nimport { SettingsModal } from './components/SettingsModal';\n\nconst escapeHtml = (str: string) =>\n  str.replace(/&/g, '&amp;').replace(/</g, '&lt;')\n     .replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\nconst isValidUrl = (url: string) => {\n  try {\n    const parsed = new URL(url);\n    return ['http:', 'https:', 'mailto:'].includes(parsed.protocol);\n  } catch { return false; }\n};\n\nfunction App() {\n  const [blocks, setBlocks] = useState<Block[]>([]);\n  const { showToast } = useToast();\n  const [activeTab, setActiveTab] = useState<'editor' | 'preview'>('editor');\n  \n  // Settings State\n  const [showSettings, setShowSettings] = useState(false);\n  const [exportPath, setExportPath] = useState('');\n\n  // Resize State\n  const [editorWidth, setEditorWidth] = useState(50); // Percentage\n  const [isResizing, setIsResizing] = useState(false);\n\n  // Save/Load State\n  const [newsletterId, setNewsletterId] = useState<string | null>(null);\n  const [title, setTitle] = useState('Untitled Newsletter');\n  const [savedNewsletters, setSavedNewsletters] = useState<NewsletterSummary[]>([]);\n\n  // History State\n  const [history, setHistory] = useState<Block[][]>([[]]);\n  const [historyIndex, setHistoryIndex] = useState(0);\n\n  // Undo/Redo Handlers\n  const updateBlocks = useCallback((newBlocksOrFn: Block[] | ((prev: Block[]) => Block[])) => {\n    setBlocks(prev => {\n      const nextBlocks = typeof newBlocksOrFn === 'function' ? newBlocksOrFn(prev) : newBlocksOrFn;\n      \n      // Only update history if blocks actually changed and it's not a re-render\n      if (JSON.stringify(prev) !== JSON.stringify(nextBlocks)) {\n        const newHistory = history.slice(0, historyIndex + 1);\n        newHistory.push(nextBlocks);\n        setHistory(newHistory);\n        setHistoryIndex(newHistory.length - 1);\n      }\n      return nextBlocks;\n    });\n  }, [history, historyIndex]);\n\n  const undo = useCallback(() => {\n    if (historyIndex > 0) {\n      const newIndex = historyIndex - 1;\n      setHistoryIndex(newIndex);\n      setBlocks(history[newIndex]);\n    }\n  }, [history, historyIndex]);\n\n  const redo = useCallback(() => {\n    if (historyIndex < history.length - 1) {\n      const newIndex = historyIndex + 1;\n      setHistoryIndex(newIndex);\n      setBlocks(history[newIndex]);\n    }\n  }, [history, historyIndex]);\n\n  // Load Settings on Mount\n  useEffect(() => {\n    fetch('/api/settings')\n      .then(res => res.json())\n      .then(data => {\n        if (data.exportPath) setExportPath(data.exportPath);\n      })\n      .catch(err => console.error('Failed to load settings', err));\n  }, []);\n\n  // Resize Handlers\n  const startResizing = (_mouseDownEvent: React.MouseEvent) => {\n      setIsResizing(true);\n  };\n\n  const stopResizing = () => {\n      setIsResizing(false);\n  };\n\n  const resize = (mouseMoveEvent: MouseEvent) => {\n      if (isResizing) {\n          const mainLayout = document.querySelector('.main-layout');\n          if (mainLayout) {\n              const { left, width } = mainLayout.getBoundingClientRect();\n              const newEditorWidth = ((mouseMoveEvent.clientX - left) / width) * 100;\n              if (newEditorWidth > 20 && newEditorWidth < 80) {\n                  setEditorWidth(newEditorWidth);\n              }\n          }\n      }\n  };\n\n  useEffect(() => {\n      window.addEventListener('mousemove', resize);\n      window.addEventListener('mouseup', stopResizing);\n      return () => {\n          window.removeEventListener('mousemove', resize);\n          window.removeEventListener('mouseup', stopResizing);\n      };\n  }, [isResizing]);\n\n  // Load newsletters on mount & Restore state\n  useEffect(() => {\n      fetchNewsletters();\n      \n      const savedDraft = sessionStorage.getItem('newsletter_draft');\n      if (savedDraft) {\n          try {\n              const { id, title: savedTitle, blocks: savedBlocks } = JSON.parse(savedDraft);\n              if (savedBlocks && savedBlocks.length > 0) {\n                  setBlocks(savedBlocks);\n                  // Reset history for loaded draft\n                  setHistory([savedBlocks]);\n                  setHistoryIndex(0);\n                  setNewsletterId(id || null);\n                  setTitle(savedTitle || 'Untitled Newsletter');\n              }\n          } catch (e) {\n              console.error('Failed to restore draft', e);\n          }\n      }\n  }, []);\n\n  // Persist state to localStorage whenever it changes (Debounced)\n  useEffect(() => {\n    const saveToLocalStorage = setTimeout(() => {\n      if (blocks.length > 0 || title !== 'Untitled Newsletter') {\n        const newsletter = {\n          id: newsletterId || Date.now().toString(),\n          title,\n          blocks,\n          createdAt: new Date().toISOString(),\n          updatedAt: new Date().toISOString(),\n        };\n        sessionStorage.setItem('newsletter_draft', JSON.stringify(newsletter));\n      }\n    }, 1000);\n\n    return () => clearTimeout(saveToLocalStorage);\n  }, [blocks, title, newsletterId]);\n\n  const fetchNewsletters = async () => {\n      try {\n          const res = await fetch('/api/newsletters');\n          if (res.ok) {\n              const data = await res.json();\n              setSavedNewsletters(data);\n          }\n      } catch (error) {\n          console.error('Failed to load list', error);\n      }\n  };\n\n\n  const handleSave = useCallback(async () => {\n    let saveTitle = title;\n    \n    if (!newsletterId && title === 'Untitled Newsletter') {\n        const firstTextBlock = blocks.find(b => b.type === 'text' && (b as any).content);\n        if (firstTextBlock && (firstTextBlock as any).content) {\n            const tempDiv = document.createElement('div');\n            tempDiv.innerHTML = (firstTextBlock as any).content;\n            const plainText = tempDiv.textContent || '';\n            const firstSentence = plainText.split(/[.!?]/)[0].trim().substring(0, 30);\n            \n            if (firstSentence) {\n                saveTitle = firstSentence;\n            }\n        }\n\n        let uniqueTitle = saveTitle;\n        let counter = 1;\n        while (savedNewsletters.some(n => n.title === uniqueTitle)) {\n            uniqueTitle = `${saveTitle} (${counter})`;\n            counter++;\n        }\n        saveTitle = uniqueTitle;\n    }\n\n    if (!newsletterId) {\n        const input = window.prompt('Enter newsletter title:', saveTitle);\n        if (input === null) return;\n        saveTitle = input || saveTitle;\n        setTitle(saveTitle);\n    }\n\n    try {\n        const response = await fetch('/api/newsletters', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n                id: newsletterId,\n                title: saveTitle,\n                blocks\n            })\n        });\n        \n        if (!response.ok) throw new Error('Failed to save');\n        \n        const data = await response.json();\n        setNewsletterId(data.id);\n        showToast('Newsletter saved successfully!', 'success');\n        fetchNewsletters();\n    } catch (error) {\n        console.error(error);\n        console.error('Failed to save newsletter');\n        showToast('Failed to save newsletter', 'error');\n    }\n  }, [blocks, title, newsletterId, savedNewsletters, showToast]);\n\n  // Keyboard Shortcuts\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.ctrlKey || e.metaKey) {\n        if (e.key === 's') {\n          e.preventDefault();\n          handleSave();\n        } else if (e.key === 'z') {\n          e.preventDefault();\n          undo();\n        } else if (e.key === 'y') {\n          e.preventDefault();\n          redo();\n        }\n      }\n    };\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [handleSave, undo, redo]);\n\n  const loadNewsletter = async (id: string) => {\n      try {\n          const res = await fetch(`/api/newsletters/${id}`);\n          if (res.ok) {\n              const data = await res.json();\n              setBlocks(data.blocks || []);\n              // Reset History\n              setHistory([data.blocks || []]);\n              setHistoryIndex(0);\n              \n              setNewsletterId(data.id);\n              setTitle(data.title);\n              // showToast('Newsletter loaded!', 'success'); // Disabled per user request\n          }\n      } catch (error) {\n          console.error('Failed to load newsletter');\n          showToast('Failed to load newsletter', 'error');\n      }\n  };\n\n  const handleNewNewsletter = () => {\n      if (window.confirm('Start a new newsletter? Unsaved changes will be lost.')) {\n          setBlocks([]);\n          setHistory([[]]);\n          setHistoryIndex(0);\n          setNewsletterId(null);\n          setTitle('Untitled Newsletter');\n          setActiveTab('editor');\n          sessionStorage.removeItem('newsletter_draft');\n      }\n  };\n\n  const handleDeleteNewsletter = async (e: React.MouseEvent, id: string, title: string) => {\n    e.stopPropagation(); // Prevent loading the newsletter when clicking delete\n    \n    if (window.confirm(`Are you sure you want to delete \"${title}\"?`)) {\n        try {\n            const res = await fetch(`/api/newsletters/${id}`, { method: 'DELETE' });\n            if (res.ok) {\n                // If deleting the currently loaded one, reset editor\n                if (newsletterId === id) {\n                    handleNewNewsletter();\n                }\n                fetchNewsletters();\n            } else {\n                showToast('Failed to delete newsletter', 'error');\n            }\n        } catch (error) {\n            console.error('Failed to delete', error);\n            showToast('Failed to delete newsletter', 'error');\n        }\n    }\n  };\n\n\n\n  const generateHtml = (blockList: Block[] = blocks) => {\n    const rows = blockList.map(block => {\n      if (block.type === 'image') {\n        const safeLink = block.link && isValidUrl(block.link) ? escapeHtml(block.link) : '';\n        // 단일 링크 (전체 이미지 클릭)\n        const linkStart = safeLink ? `<a href=\"${safeLink}\" target=\"_blank\" style=\"text-decoration: none; display: block;\">` : '';\n        const linkEnd = safeLink ? '</a>' : '';\n\n        // PDF에서 추출된 오버레이 링크들\n        // 서버에서 1600px 기준으로 좌표가 계산되어 있고, display는 800px이므로 0.5 스케일\n        const displayScale = 0.5;\n        const overlayLinks = (block.links || []).map(link => {\n            if (!isValidUrl(link.url)) return '';\n            const safeUrl = escapeHtml(link.url);\n            return `\n          <a href=\"${safeUrl}\" target=\"_blank\" style=\"\n            position: absolute;\n            left: ${link.x * displayScale}px;\n            top: ${link.y * displayScale}px;\n            width: ${link.width * displayScale}px;\n            height: ${link.height * displayScale}px;\n            z-index: 10;\n            cursor: pointer;\n          \" title=\"${safeUrl}\"></a>\n        `}).join('');\n\n        // 오버레이 링크가 있으면 position: relative 컨테이너 필요\n        if (overlayLinks) {\n          return `\n            <tr>\n              <td align=\"center\" style=\"padding: 0;\">\n                <div style=\"position: relative; display: inline-block; width: 100%; max-width: 800px;\">\n                  <img src=\"${block.src}\" alt=\"${block.alt || ''}\" style=\"display: block; width: 100%; max-width: 800px; height: auto; border: 0;\" />\n                  ${overlayLinks}\n                </div>\n              </td>\n            </tr>\n          `;\n        }\n\n        return `\n          <tr>\n            <td align=\"center\" style=\"padding: 0;\">\n              ${linkStart}<img src=\"${block.src}\" alt=\"${block.alt || ''}\" style=\"display: block; width: 100%; max-width: 800px; height: auto; border: 0;\" />${linkEnd}\n            </td>\n          </tr>\n        `;\n      } else if (block.type === 'text') {\n        return `\n          <tr>\n            <td style=\"padding: 20px; font-family: sans-serif; font-size: 16px; line-height: 1.5; color: #333;\">\n              ${block.content}\n            </td>\n          </tr>\n        `;\n      }\n      return '';\n    }).join('');\n\n    return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>${title}</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f4;\">\n  <table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width: 800px; background-color: #ffffff; margin: 0 auto;\">\n    ${rows}\n  </table>\n</body>\n</html>\n    `;\n  };\n\n  const html = generateHtml();\n\n  const saveSettings = async (path: string) => {\n    try {\n      await fetch('/api/settings', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ exportPath: path })\n      });\n      setExportPath(path);\n      // showToast('Settings saved', 'success');\n    } catch (err) {\n      console.error('Failed to save settings');\n      // showToast('Failed to save settings', 'error');\n    }\n  };\n\n  const handleExportHtml = async () => {\n    const filename = `${title.replace(/[^a-z0-9가-힣]/gi, '_') || 'newsletter'}.html`;\n\n    // Convert images to Base64 for standalone HTML\n    const blocksWithBase64 = await Promise.all(\n      blocks.map(async (block) => {\n        if (block.type === 'image' && block.src.startsWith('/uploads/')) {\n          try {\n            const res = await fetch(`/api/image-base64?path=${encodeURIComponent(block.src)}`);\n            if (res.ok) {\n              const { dataUri } = await res.json();\n              return { ...block, src: dataUri };\n            }\n          } catch (e) {\n            console.error('Failed to convert image to base64', e);\n          }\n        }\n        return block;\n      })\n    );\n\n    const exportHtml = generateHtml(blocksWithBase64);\n\n    // Case 1: Default Export Path is Set (Server-side auto-save)\n    if (exportPath) {\n      try {\n        const res = await fetch('/api/export', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            html: exportHtml,\n            path: exportPath,\n            filename\n          })\n        });\n\n        if (res.ok) {\n          showToast(`Exported to ${exportPath}\\\\${filename}`, 'success');\n        } else {\n          const err = await res.json();\n          throw new Error(err.error);\n        }\n      } catch (e: unknown) {\n        const errorMessage = e instanceof Error ? e.message : String(e);\n        console.error(e);\n        console.error(`Auto-export failed: ${errorMessage}`);\n        showToast(`Auto-export failed: ${errorMessage}`, 'error');\n      }\n      return;\n    }\n\n    // Case 2: No Default Path (Client-side Save As Dialog)\n    try {\n      // Try Native File System Access API\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      if ('showSaveFilePicker' in window) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const handle = await (window as any).showSaveFilePicker({\n          suggestedName: filename,\n          types: [{\n            description: 'HTML File',\n            accept: { 'text/html': ['.html'] },\n          }],\n        });\n        const writable = await handle.createWritable();\n        await writable.write(exportHtml);\n        await writable.close();\n        showToast('Export successful!', 'success');\n      } \n      // Fallback: Classic Download\n      else {\n        const blob = new Blob([exportHtml], { type: 'text/html' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n        showToast('Export successful!', 'success');\n      }\n    } catch (err: unknown) {\n      // Ignore 'AbortError' (Cancel button)\n      if (err instanceof Error && err.name !== 'AbortError') {\n        console.error(err);\n        console.error('Export canceled or failed', err);\n        showToast('Export canceled or failed', 'error');\n      }\n    }\n  };\n\n  const handleOpenFolder = async () => {\n    if (!exportPath) {\n      // showToast('No export path configured', 'error');\n      setShowSettings(true);\n      return;\n    }\n    \n    try {\n      await fetch('/api/open-folder', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ path: exportPath })\n      });\n    } catch (error) {\n      console.error(error);\n      console.error('Failed to open folder', error);\n      // showToast('Failed to open folder', 'error');\n    }\n  };\n\n  return (\n    <div className=\"app-container\">\n      {/* Sidebar */}\n      <aside className=\"app-sidebar\">\n        <div className=\"sidebar-header\">\n           <button className=\"new-btn\" onClick={handleNewNewsletter}>\n             <span>+</span> New Newsletter\n           </button>\n        </div>\n        <div className=\"sidebar-list\">\n           <h3>Recent</h3>\n           {savedNewsletters.length === 0 && <p className=\"empty-list\">No saved items.</p>}\n           <ul>\n             {savedNewsletters.map(n => (\n                 <li \n                   key={n.id} \n                   className={n.id === newsletterId ? 'active' : ''}\n                   onClick={() => loadNewsletter(n.id)}\n                 >\n                    <span className=\"item-title\">{n.title}</span>\n                    <button \n                       className=\"delete-item-btn\"\n                       onClick={(e) => handleDeleteNewsletter(e, n.id, n.title)}\n                       title=\"Delete\"\n                    >\n                       <Trash2 size={16} />\n                    </button>\n                 </li>\n             ))}\n           </ul>\n        </div>\n      </aside>\n\n      <div className=\"main-layout\">\n        <header className=\"app-header\">\n              <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>\n                <Mail color=\"#2563eb\" size={32} />\n                <div>\n                  <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 600 }}>Newsletter Editor</h2>\n                  <small style={{ color: '#666', display: 'block', marginTop: '2px' }}>{title}</small>\n                </div>\n              </div>\n          <div className=\"header-actions\">\n            <button className=\"icon-btn\" onClick={handleOpenFolder} title={exportPath ? `Open Folder: ${exportPath}` : 'Open Export Folder'}>\n              <FolderOpen size={20} />\n            </button>\n            <button className=\"icon-btn\" onClick={() => setShowSettings(true)} title=\"Settings\">\n              <Settings size={20} />\n            </button>\n            <button className=\"btn-secondary\" onClick={handleExportHtml} title=\"Export HTML\">\n              <Download size={16} /> Export\n            </button>\n            <button className=\"btn-primary\" onClick={handleSave}>\n              <span>💾</span> Save\n            </button>\n          </div>\n        </header>\n\n        <div className=\"mobile-tabs\">\n          <button \n            className={`tab-btn ${activeTab === 'editor' ? 'active' : ''}`}\n            onClick={() => setActiveTab('editor')}\n          >\n            Editor\n          </button>\n          <button \n            className={`tab-btn ${activeTab === 'preview' ? 'active' : ''}`}\n            onClick={() => setActiveTab('preview')}\n          >\n            Preview\n          </button>\n        </div>\n        \n        <main className=\"app-content\" onMouseUp={stopResizing}>\n          <aside \n            className={`editor-panel ${activeTab === 'editor' ? 'active' : ''}`}\n            style={{ width: `${editorWidth}%`, flex: 'none' }}\n          >\n            <h3>Editor</h3>\n            <BlockList blocks={blocks} setBlocks={updateBlocks} />\n          </aside>\n\n          {/* Resizer Handle */}\n          <div \n             className=\"resizer\"\n             onMouseDown={startResizing}\n          ></div>\n          \n          <section \n            className={`preview-panel ${activeTab === 'preview' ? 'active' : ''}`}\n            style={{ flex: 1 }}\n          >\n            {blocks.length > 0 ? (\n              <Preview html={html} />\n            ) : (\n              <div className=\"empty-state\">\n                <Mail size={48} opacity={0.2} />\n                <p>Add content blocks to see preview</p>\n              </div>\n            )}\n          </section>\n        </main>\n      </div>\n\n      <SettingsModal \n        isOpen={showSettings} \n        onClose={() => setShowSettings(false)} \n        currentPath={exportPath}\n        onSave={saveSettings}\n      />\n    </div>\n  );\n}\n\nexport default App;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\CopyButtons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Editor\\BlockList.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3030,3033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3030,3033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport type { Block, BlockType, ImageBlock } from '../../types';\r\nimport { RichTextEditor } from './RichTextEditor';\r\nimport { GripVertical, Image as ImageIcon, Type, Link as LinkIcon, X } from 'lucide-react';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { FileUploader } from '../FileUploader';\r\nimport { uploadImage } from '../../services/api';\r\nimport { useToast } from '../../components/Toast';\r\nimport {\r\n  DndContext,\r\n  closestCenter,\r\n  KeyboardSensor,\r\n  PointerSensor,\r\n  useSensor,\r\n  useSensors,\r\n} from '@dnd-kit/core';\r\nimport type { DragEndEvent } from '@dnd-kit/core';\r\nimport {\r\n  arrayMove,\r\n  SortableContext,\r\n  sortableKeyboardCoordinates,\r\n  verticalListSortingStrategy,\r\n  useSortable,\r\n} from '@dnd-kit/sortable';\r\nimport { CSS } from '@dnd-kit/utilities';\r\nimport './Editor.css';\r\n\r\ninterface BlockListProps {\r\n  blocks: Block[];\r\n  setBlocks: React.Dispatch<React.SetStateAction<Block[]>>;\r\n}\r\n\r\nexport const BlockList: React.FC<BlockListProps> = ({ blocks, setBlocks }) => {\r\n  const [uploadingBlockId, setUploadingBlockId] = useState<string | null>(null);\r\n  const { showToast } = useToast();\r\n\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor),\r\n    useSensor(KeyboardSensor, {\r\n      coordinateGetter: sortableKeyboardCoordinates,\r\n    })\r\n  );\r\n\r\n  const handleDragEnd = (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n\r\n    if (over && active.id !== over.id) {\r\n      setBlocks((items) => {\r\n        const oldIndex = items.findIndex((item) => item.id === active.id);\r\n        const newIndex = items.findIndex((item) => item.id === over.id);\r\n        return arrayMove(items, oldIndex, newIndex);\r\n      });\r\n    }\r\n  };\r\n\r\n  const addBlock = (type: BlockType, index: number) => {\r\n    if (type === 'image') {\r\n      const newBlock: Block = { id: uuidv4(), type: 'placeholder' };\r\n      const newBlocks = [...blocks];\r\n      newBlocks.splice(index, 0, newBlock);\r\n      setBlocks(newBlocks);\r\n      return;\r\n    }\r\n\r\n    const newBlock: Block = { id: uuidv4(), type: 'text', content: '' };\r\n    const newBlocks = [...blocks];\r\n    newBlocks.splice(index, 0, newBlock);\r\n    setBlocks(newBlocks);\r\n  };\r\n\r\n  const handleInlineUpload = async (file: File, sliceHeight: number, blockId: string) => {\r\n    setUploadingBlockId(blockId);\r\n    try {\r\n      const slices = await uploadImage(file, sliceHeight);\r\n      const newBlocks: Block[] = slices.map(slice => ({\r\n        id: uuidv4(),\r\n        type: 'image',\r\n        src: slice.imageUrl,\r\n        alt: file.name,\r\n        links: slice.links\r\n      }));\r\n      \r\n      setBlocks(prev => {\r\n        const index = prev.findIndex(b => b.id === blockId);\r\n        if (index === -1) return prev;\r\n        \r\n        const copy = [...prev];\r\n        // Remove the placeholder and insert new blocks\r\n        copy.splice(index, 1, ...newBlocks);\r\n        return copy;\r\n      });\r\n      \r\n      showToast(`Successfully added ${slices.length} image slice(s)`, 'success');\r\n    } catch (error: any) {\r\n      console.error(error);\r\n      // alert(`Upload Error: ${error.message}`); // Removed alert, relying on Toast\r\n      showToast(error.message || 'Failed to upload image', 'error');\r\n    } finally {\r\n      setUploadingBlockId(null);\r\n    }\r\n  };\r\n\r\n  const updateBlock = (id: string, updates: Partial<Block>) => {\r\n    setBlocks(blocks.map(b => b.id === id ? { ...b, ...updates } as Block : b));\r\n  };\r\n\r\n  const deleteBlock = (id: string) => {\r\n    setBlocks(blocks.filter(b => b.id !== id));\r\n  };\r\n\r\n  return (\r\n    <div className=\"block-list\">\r\n\r\n      <InsertZone onInsert={(type) => addBlock(type, 0)} visible={blocks.length === 0} />\r\n\r\n      <DndContext\r\n        sensors={sensors}\r\n        collisionDetection={closestCenter}\r\n        onDragEnd={handleDragEnd}\r\n      >\r\n        <SortableContext\r\n          items={blocks.map(b => b.id)}\r\n          strategy={verticalListSortingStrategy}\r\n        >\r\n          {blocks.map((block, index) => (\r\n            <React.Fragment key={block.id}>\r\n              <SortableBlockItem\r\n                block={block}\r\n                updateBlock={updateBlock}\r\n                deleteBlock={deleteBlock}\r\n                uploading={uploadingBlockId === block.id}\r\n                onUpload={(file, height) => handleInlineUpload(file, height, block.id)}\r\n                index={index}\r\n              />\r\n              <InsertZone onInsert={(type) => addBlock(type, index + 1)} />\r\n            </React.Fragment>\r\n          ))}\r\n        </SortableContext>\r\n      </DndContext>\r\n    </div>\r\n  );\r\n};\r\n\r\ninterface SortableBlockItemProps {\r\n  block: Block;\r\n  updateBlock: (id: string, updates: Partial<Block>) => void;\r\n  deleteBlock: (id: string) => void;\r\n  uploading?: boolean;\r\n  onUpload?: (file: File, height: number) => void;\r\n  index: number;\r\n}\r\n\r\nconst SortableBlockItem: React.FC<SortableBlockItemProps> = ({ block, updateBlock, deleteBlock, uploading, onUpload, index }) => {\r\n  const {\r\n    attributes,\r\n    listeners,\r\n    setNodeRef,\r\n    transform,\r\n    transition,\r\n    isDragging,\r\n  } = useSortable({ id: block.id });\r\n\r\n  const style = {\r\n    transform: CSS.Transform.toString(transform),\r\n    transition,\r\n    opacity: isDragging ? 0.5 : 1,\r\n    zIndex: isDragging ? 2 : 1,\r\n  };\r\n\r\n  const [linkInputVisible, setLinkInputVisible] = useState(false);\r\n\r\n  const renderContent = () => {\r\n    if (block.type === 'placeholder') {\r\n      return (\r\n        <div className=\"placeholder-block\">\r\n          {onUpload && <FileUploader onUpload={onUpload} isProcessing={!!uploading} />}\r\n        </div>\r\n      );\r\n    }\r\n\r\n    if (block.type === 'text') {\r\n      return (\r\n        <RichTextEditor \r\n          content={block.content} \r\n          onChange={(val) => updateBlock(block.id, { content: val })} \r\n        />\r\n      );\r\n    }\r\n\r\n    // Image Block\r\n    const imgBlock = block as ImageBlock;\r\n    return (\r\n      <div className=\"image-block-wrapper\">\r\n        <div className=\"image-block\">\r\n          <img src={imgBlock.src} alt=\"Newsletter Content\" />\r\n          {imgBlock.link && <div className=\"link-badge\"><LinkIcon size={12} /> {imgBlock.link}</div>}\r\n        </div>\r\n        \r\n        <div className=\"image-actions\">\r\n           <button \r\n             className={`link-btn ${linkInputVisible || imgBlock.link ? 'active' : ''}`}\r\n             onClick={() => setLinkInputVisible(!linkInputVisible)}\r\n             title=\"Add Link to Image\"\r\n           >\r\n             <LinkIcon size={16} /> {imgBlock.link ? 'Edit Link' : 'Add Link'}\r\n           </button>\r\n        </div>\r\n\r\n        {linkInputVisible && (\r\n          <div className=\"link-input-popover\">\r\n            <input \r\n              type=\"text\" \r\n              placeholder=\"https://example.com\" \r\n              value={imgBlock.link || ''} \r\n              onChange={(e) => updateBlock(block.id, { link: e.target.value })}\r\n            />\r\n            <button onClick={() => setLinkInputVisible(false)}>Done</button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div ref={setNodeRef} style={style} className=\"block-item\">\r\n      <div className=\"block-controls-persistent\">\r\n        <span className=\"block-number\">[{index + 1}]</span>\r\n        <button className=\"drag-handle\" {...attributes} {...listeners}>\r\n          <GripVertical size={20} />\r\n        </button>\r\n      </div>\r\n      \r\n      <button className=\"delete-btn\" onClick={() => deleteBlock(block.id)} title=\"Delete Block\">\r\n        <X size={18} />\r\n      </button>\r\n\r\n      {renderContent()}\r\n    </div>\r\n  );\r\n};\r\n\r\ninterface InsertZoneProps {\r\n  onInsert: (type: BlockType) => void;\r\n  visible?: boolean;\r\n}\r\n\r\nconst InsertZone: React.FC<InsertZoneProps> = ({ onInsert, visible }) => {\r\n  return (\r\n    <div className={`insert-zone ${visible ? 'visible' : ''}`}>\r\n      <div className=\"insert-line\"></div>\r\n      <div className=\"insert-buttons\">\r\n        <button className=\"insert-btn\" onClick={() => onInsert('text')}>\r\n          <Type size={14} /> Text\r\n        </button>\r\n        <button className=\"insert-btn\" onClick={() => onInsert('image')}>\r\n          <ImageIcon size={14} /> Image\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Editor\\RichTextEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[311,314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[311,314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Editor\\RichTextEditor.tsx:85:46\n  83 | export const RichTextEditor: React.FC<RichTextEditorProps> = ({ content, onChange }) => {\n  84 |   // Generate unique ID for this editor's toolbar\n> 85 |   const toolbarId = useMemo(() => `toolbar-${Math.random().toString(36).substring(2, 9)}`, []);\n     |                                              ^^^^^^^^^^^^^ Cannot call impure function\n  86 |\n  87 |   const modules = useMemo(() => ({\n  88 |     toolbar: {","line":85,"column":46,"nodeType":null,"endLine":85,"endColumn":59}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo } from 'react';\r\nimport ReactQuill from 'react-quill-new';\r\nimport 'react-quill-new/dist/quill.snow.css';\r\nimport './Editor.css';\r\n\r\ninterface RichTextEditorProps {\r\n  content: string;\r\n  onChange: (content: string) => void;\r\n}\r\n\r\nconst Font = ReactQuill.Quill.import('formats/font') as any;\r\n// Whitelist of fonts\r\nFont.whitelist = [\r\n  'malgun-gothic', \r\n  'gulim', \r\n  'dotum', \r\n  'nanum-gothic', \r\n  'noto-sans-kr',\r\n  'sans-serif', \r\n  'serif', \r\n  'monospace'\r\n];\r\nReactQuill.Quill.register(Font, true);\r\n\r\nconst CustomToolbar = ({ id }: { id: string }) => (\r\n  <div id={id}>\r\n    <span className=\"ql-formats\">\r\n      <select className=\"ql-header\" defaultValue=\"\" title=\"문단 형식\">\r\n        <option value=\"1\">제목 1</option>\r\n        <option value=\"2\">제목 2</option>\r\n        <option value=\"\">본문</option>\r\n      </select>\r\n      <select className=\"ql-font\" defaultValue=\"malgun-gothic\" title=\"글꼴\">\r\n        <option value=\"malgun-gothic\">맑은 고딕</option>\r\n        <option value=\"gulim\">굴림</option>\r\n        <option value=\"dotum\">돋움</option>\r\n        <option value=\"nanum-gothic\">나눔고딕</option>\r\n        <option value=\"noto-sans-kr\">Noto Sans KR</option>\r\n        <option value=\"sans-serif\">Sans Serif</option>\r\n        <option value=\"serif\">Serif</option>\r\n        <option value=\"monospace\">Monospace</option>\r\n      </select>\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <button className=\"ql-bold\" title=\"굵게 (Ctrl+B)\" />\r\n      <button className=\"ql-italic\" title=\"기울임 (Ctrl+I)\" />\r\n      <button className=\"ql-underline\" title=\"밑줄 (Ctrl+U)\" />\r\n      <button className=\"ql-strike\" title=\"취소선\" />\r\n      <button className=\"ql-blockquote\" title=\"인용구\" />\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <button className=\"ql-list\" value=\"ordered\" title=\"번호 매기기\" />\r\n      <button className=\"ql-list\" value=\"bullet\" title=\"글머리 기호\" />\r\n      <button className=\"ql-indent\" value=\"-1\" title=\"내어쓰기\" />\r\n      <button className=\"ql-indent\" value=\"+1\" title=\"들여쓰기\" />\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <select className=\"ql-color\" title=\"글자 색상\" />\r\n      <select className=\"ql-background\" title=\"배경 색상\" />\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <select className=\"ql-align\" title=\"정렬\" />\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <button className=\"ql-link\" title=\"링크 삽입\" />\r\n      <button className=\"ql-image\" title=\"이미지 삽입\" />\r\n    </span>\r\n    <span className=\"ql-formats\">\r\n      <button className=\"ql-clean\" title=\"서식 지우기\" />\r\n    </span>\r\n  </div>\r\n);\r\n\r\nconst formats = [\r\n  'header', 'font',\r\n  'bold', 'italic', 'underline', 'strike', 'blockquote',\r\n  'list', 'indent',\r\n  'link', 'image',\r\n  'color', 'background',\r\n  'align'\r\n];\r\n\r\nexport const RichTextEditor: React.FC<RichTextEditorProps> = ({ content, onChange }) => {\r\n  // Generate unique ID for this editor's toolbar\r\n  const toolbarId = useMemo(() => `toolbar-${Math.random().toString(36).substring(2, 9)}`, []);\r\n\r\n  const modules = useMemo(() => ({\r\n    toolbar: {\r\n      container: `#${toolbarId}`,\r\n    },\r\n  }), [toolbarId]);\r\n\r\n  return (\r\n    <div className=\"rich-text-editor\">\r\n      <CustomToolbar id={toolbarId} />\r\n      <ReactQuill \r\n        theme=\"snow\"\r\n        value={content}\r\n        onChange={onChange}\r\n        modules={modules}\r\n        formats={formats}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\FileUploader.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\FileUploader.tsx:20:7\n  18 |     let interval: ReturnType<typeof setInterval>;\n  19 |     if (isProcessing) {\n> 20 |       setProgress(0);\n     |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  21 |       interval = setInterval(() => {\n  22 |         setProgress((prev) => {\n  23 |           if (prev >= 90) return prev;","line":20,"column":7,"nodeType":null,"endLine":20,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\r\nimport { Upload, CheckCircle } from 'lucide-react';\r\nimport './FileUploader.css';\r\n\r\ninterface FileUploaderProps {\r\n  onUpload: (file: File, sliceHeight: number) => void;\r\n  isProcessing: boolean;\r\n}\r\n\r\nexport const FileUploader: React.FC<FileUploaderProps> = ({ onUpload, isProcessing }) => {\r\n  const [dragActive, setDragActive] = useState(false);\r\n  const [file, setFile] = useState<File | null>(null);\r\n  const [progress, setProgress] = useState(0);\r\n  const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Simulate progress when processing starts\r\n  useEffect(() => {\r\n    let interval: ReturnType<typeof setInterval>;\r\n    if (isProcessing) {\r\n      setProgress(0);\r\n      interval = setInterval(() => {\r\n        setProgress((prev) => {\r\n          if (prev >= 90) return prev;\r\n          return prev + 10;\r\n        });\r\n      }, 500);\r\n    } else {\r\n      setProgress(100);\r\n      setTimeout(() => setProgress(0), 1000);\r\n    }\r\n    return () => clearInterval(interval);\r\n  }, [isProcessing]);\r\n\r\n  const processFile = (selectedFile: File) => {\r\n    setFile(selectedFile);\r\n    onUpload(selectedFile, 0); // 0 means no slicing\r\n  };\r\n\r\n  const handleDrag = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    if (e.type === 'dragenter' || e.type === 'dragover') {\r\n      setDragActive(true);\r\n    } else if (e.type === 'dragleave') {\r\n      setDragActive(false);\r\n    }\r\n  };\r\n\r\n  const handleDrop = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setDragActive(false);\r\n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\r\n      processFile(e.dataTransfer.files[0]);\r\n    }\r\n  };\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    e.preventDefault();\r\n    if (e.target.files && e.target.files[0]) {\r\n      processFile(e.target.files[0]);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"uploader-container\">\r\n      <div \r\n        className={`drop-zone ${dragActive ? 'active' : ''} ${isProcessing ? 'processing' : ''}`}\r\n        onDragEnter={handleDrag}\r\n        onDragLeave={handleDrag}\r\n        onDragOver={handleDrag}\r\n        onDrop={handleDrop}\r\n        onClick={() => !isProcessing && inputRef.current?.click()}\r\n      >\r\n        <input \r\n          ref={inputRef} \r\n          type=\"file\" \r\n          className=\"file-input\" \r\n          onChange={handleChange} \r\n          accept=\"image/*,.pdf\" \r\n          disabled={isProcessing}\r\n        />\r\n        \r\n        {isProcessing ? (\r\n          <div className=\"processing-state\">\r\n            <div className=\"spinner\"></div>\r\n            <p>Processing... {progress}%</p>\r\n            <div className=\"progress-bar\">\r\n              <div className=\"progress-fill\" style={{ width: `${progress}%` }}></div>\r\n            </div>\r\n          </div>\r\n        ) : file ? (\r\n          <div className=\"file-info success\">\r\n             <CheckCircle className=\"icon-success\" size={40} />\r\n             <div>\r\n               <p className=\"file-name\">Processed: {file.name}</p>\r\n               <p className=\"sub-text\">Drop another file to append</p>\r\n             </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"upload-prompt\">\r\n            <Upload className=\"icon-upload\" size={40} />\r\n            <p className=\"main-text\">Drag & Drop PDF/Image</p>\r\n            <p className=\"sub-text\">Auto-convert to image block (Max 50MB)</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Preview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\SettingsModal.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\SettingsModal.tsx:16:5\n  14 |\n  15 |   useEffect(() => {\n> 16 |     setPath(currentPath);\n     |     ^^^^^^^ Avoid calling setState() directly within an effect\n  17 |   }, [currentPath, isOpen]);\n  18 |\n  19 |   if (!isOpen) return null;","line":16,"column":5,"nodeType":null,"endLine":16,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { X, FolderOpen } from 'lucide-react';\r\nimport './SettingsModal.css';\r\n\r\ninterface SettingsModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  currentPath: string;\r\n  onSave: (path: string) => void;\r\n}\r\n\r\nexport const SettingsModal: React.FC<SettingsModalProps> = ({ isOpen, onClose, currentPath, onSave }) => {\r\n  const [path, setPath] = useState(currentPath);\r\n\r\n  useEffect(() => {\r\n    setPath(currentPath);\r\n  }, [currentPath, isOpen]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  const handleSave = () => {\r\n    onSave(path);\r\n    onClose();\r\n  };\r\n\r\n  const handleBrowse = async () => {\r\n    try {\r\n      const res = await fetch('/api/pick-folder');\r\n      const data = await res.json();\r\n      if (data.path) {\r\n        setPath(data.path);\r\n      } else if (data.error) {\r\n        alert(data.error);\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to open picker', error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"settings-modal-overlay\">\r\n      <div className=\"settings-modal\">\r\n        <div className=\"settings-header\">\r\n          <h3>Settings</h3>\r\n          <button onClick={onClose} className=\"close-btn\">\r\n            <X size={20} />\r\n          </button>\r\n        </div>\r\n        \r\n        <div className=\"settings-body\">\r\n          <div className=\"form-group\">\r\n            <label>Default Export Path</label>\r\n            <div style={{ display: 'flex', gap: '8px' }}>\r\n              <div className=\"input-with-icon\" style={{ flex: 1 }}>\r\n                <FolderOpen size={18} className=\"input-icon\" />\r\n                <input \r\n                  type=\"text\" \r\n                  value={path} \r\n                  onChange={(e) => setPath(e.target.value)} \r\n                  placeholder=\"e.g. C:/Users/Documents/Newsletters\"\r\n                />\r\n              </div>\r\n              <button onClick={handleBrowse} className=\"btn-secondary\" style={{ whiteSpace: 'nowrap' }}>\r\n                📁 Find\r\n              </button>\r\n            </div>\r\n            <p className=\"help-text\">\r\n              Server-side path. If empty, you'll be prompted to save manually.\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"settings-footer\">\r\n          <button onClick={onClose} className=\"btn-secondary\">Cancel</button>\r\n          <button onClick={handleSave} className=\"btn-primary\">Save Settings</button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\components\\Toast.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":58,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":58,"endColumn":22,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\declarations.d.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[266,269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[266,269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\services\\api.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\services\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\src\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\skawn\\Development\\newsletter-generator\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]